!function(require, directRequire){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.filterUnusedFile=void 0;const tslib_1=require("tslib"),projectconfig_1=require("../../core/json/projectconfig"),path=tslib_1.__importStar(require("path")),code_analyse_1=require("../../vendor/code-analyse"),code_analyse_2=require("../code-analyse"),babel_helper_1=require("../../utils/babel_helper"),tools_1=require("../../utils/tools");class CodeDataFileHelper{constructor(e,t){this.project=e,this.codes=t,this._dirSet=new Set,this._fileSet=new Set,this._cacheFileSize=new Map;for(const e of Object.keys(this.codes))this._fileSet.add(e),this.cacheDirName(path.posix.dirname(e))}cacheDirName(e){this._dirSet.has(e)||(this._dirSet.add(e),this.cacheDirName(path.posix.dirname(e)))}cacheFileSize(e){if(this._cacheFileSize.has(e))return this._cacheFileSize.get(e);const t=this.codes[e];let i=0;return i="string"==typeof t?Buffer.from(t,"utf-8").length:t.length,this._cacheFileSize.set(e,i),i}stat(e){const t=this._fileSet.has(e),i=this._dirSet.has(e);if(!t&&!i)return;let r=0;return r=i?Object.keys(this.codes).filter(t=>t.startsWith(e)).reduce((e,t)=>e+this.cacheFileSize(t),0):this.cacheFileSize(e),{isFile:t,isDirectory:i,size:r,mtime:0}}mtime(e){return 0}exist(e){return this.existFile(e)||this.existDir(e)}existDir(e){return e.endsWith("/")&&(e=e.replace(/\/$/,"")),this._dirSet.has(e)}existFile(e){return this._fileSet.has(e)}getFileList(e="",t=""){return Array.from(this._fileSet).filter(i=>(!t||path.extname(i)===t)&&!(e&&!i.startsWith(e)))}async getString(e){const t=this.codes[e];if("string"==typeof t)return t;if(Buffer.isBuffer(t))return t.toString("utf-8");throw new Error(e+" is not in codes")}async getLocalFileString(e){return this.project.getFile(this.project.miniprogramRoot,e).toString("utf-8")}async getJSON(e){const t=await this.getString(e);try{return JSON.parse(t)}catch(e){return null}}async readdir(e){e.endsWith("/")||(e+="/");const t=Array.from(this._fileSet).filter(t=>t.startsWith(e));return Array.from(this._dirSet).filter(t=>t.startsWith(e)).concat(t).filter(t=>t.slice(e.length).indexOf("/")<0).map(t=>t.slice(e.length))}watchFileChange(e){throw new Error("Method not implemented.")}}async function filterUnusedFile(e,t,i){var r,s;if("miniProgram"!==t.type)return i;const n=await(0,projectconfig_1.getProjectConfigJSON)(t);let o=!1;return o=e?!1!==(null===(r=n.setting)||void 0===r?void 0:r.ignoreDevUnusedFiles):!1!==(null===(s=n.setting)||void 0===s?void 0:s.ignoreUploadUnusedFiles),o?doFilterUnusedFile(t,i):i}function checkUnusedCodeFiles(e,t){const i=t.fileHelper.getFileList("").filter(e=>{return t=path.posix.extname(e),/\.(json|wxml|wxss|js|wxs|ts|less|sass|scss)/.test(t);var t}),r=new Set;t.graph.modules.forEach(e=>{const t=i.find(t=>t===e.path);t&&r.add(t)});const s=(0,babel_helper_1.getBabelOutputPath)((0,projectconfig_1.getProjectConfigJSON)(e));return i.forEach(e=>{(function(e){return e.indexOf(s)>=0})(e)&&r.add(e)}),i.filter(e=>!r.has(e))}async function doFilterUnusedFile(e,t){var i;const r=(0,projectconfig_1.getProjectConfigJSON)(e),s=(0,code_analyse_2.transCompileType)(e);if("gamePlugin"===s)throw new Error("gamePlugin is not support yet!");let n="plugin"===s?r.pluginRoot:r.miniprogramRoot;n=n?path.posix.join(e.projectPath,n):e.projectPath;const o=new CodeDataFileHelper(e,t),l=new code_analyse_1.Analyzer({root:n,type:s,fileHelper:o,plugins:[]});await l.analyse();const a=checkUnusedCodeFiles(e,l),c=(null===(i=r.packOptions)||void 0===i?void 0:i.include)||[];return((e,t)=>{const i=Object.keys(e);for(const r of i)t(r)&&delete e[r];return e})(t,e=>(e=>{if((0,tools_1.isFileIncluded)(e,c))return!1;const t=e.startsWith("/")?e:"/"+e;for(const e of a){if(t===(e.startsWith("/")?e:"/"+e))return!0}return!1})(e))}exports.filterUnusedFile=filterUnusedFile;
}(require("licia/lazyImport")(require), require)