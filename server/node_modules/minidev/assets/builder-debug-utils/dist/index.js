"use strict";var e=require("fs-extra"),t=require("bent"),n=require("crypto"),o=require("os"),a=require("path");function r(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var i=r(e),s=r(t),u=r(n),d=r(o),l=r(a),c="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function p(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var f,m,g,h={},y={};f=y,Object.defineProperty(f,"__esModule",{value:!0}),f.ECompileModeType=f.ECompileTargetType=void 0,(m=f.ECompileTargetType||(f.ECompileTargetType={})).Mini="Mini",m.Cube="Cube",(g=f.ECompileModeType||(f.ECompileModeType={})).Remote="Remote",g.Remotex="Remotex",g.RemotexLite="RemotexLite",g.Preview="Preview",g.RemoteBoatman="RemoteBoatman";var b={},C={},P={};Object.defineProperty(P,"__esModule",{value:!0}),P.libName=P.defaultConfig=void 0;const v=d.default,T=l.default,j=y;P.defaultConfig={assetsQueryUrl:"https://render.alipay.com/p/h5data/h5config_builder-debug-h5data.json",injectCodeTempPath:(0,T.join)((0,v.tmpdir)(),"./builder_debug_output_v2"),offlineDirectoryPath:(0,T.join)(__dirname,"../offline"),readonlyDirectoryPath:(0,T.join)(__dirname,"../readonly"),assetsMapFilename:"assets_map",boatmanFilename:{[j.ECompileTargetType.Mini]:"boatman_mini",[j.ECompileTargetType.Cube]:"boatman_cube"}},P.libName="builder-debug-utils";var _=c&&c.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(a,r){function i(e){try{u(o.next(e))}catch(e){r(e)}}function s(e){try{u(o.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}u((o=o.apply(e,t||[])).next())}))},w=c&&c.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(C,"__esModule",{value:!0}),C.AssetsUpdater=void 0;const M=w(s.default),B=w(i.default),O=w(u.default),A=P,R=y,S=(0,M.default)("json"),E=(0,M.default)("buffer"),I=`[${A.libName}]`;C.AssetsUpdater=class{constructor(e){this.context=e}updateOfflineAssetsToday(){return _(this,void 0,void 0,(function*(){!function(e){return _(this,void 0,void 0,(function*(){try{const t=yield B.default.stat(e),n=new Date(parseInt(`${t.mtimeMs}`,10));return(new Date).toLocaleDateString()===n.toLocaleDateString()}catch(e){return!1}}))}(this.context.getAssetsMapFilePath())?(console.log(`${I} local assets are outdated, start to download new debug assets`),yield this.updateOfflineAssets()):console.log(`${I} local assets are in the period of validity`)}))}updateOfflineAssets(){return _(this,void 0,void 0,(function*(){if(this.updatingTask)return this.updatingTask;this.updatingTask=this.runUpdateTask();try{yield this.updatingTask,this.updatingTask=void 0}catch(e){throw this.updatingTask=void 0,e}}))}runUpdateTask(){return _(this,void 0,void 0,(function*(){let e;try{e=yield S(A.defaultConfig.assetsQueryUrl)}catch(e){throw new Error("Failed to request online config")}yield Promise.all([this.updateLocalFile(this.context.getAssetsMapFilePath(),e.url_v2,e.integrity_v2),this.updateLocalFile(this.context.getBoatmanFilePath(R.ECompileTargetType.Mini),e.url_boatman_mini,e.integrity_boatman_mini),this.updateLocalFile(this.context.getBoatmanFilePath(R.ECompileTargetType.Cube),e.url_boatman_cube,e.integrity_boatman_cube)])}))}updateLocalFile(e,t,n){return _(this,void 0,void 0,(function*(){if(!t||!n)return void console.error(`${I} Empty key in config`);try{const t=yield B.default.readFile(e);if(O.default.createHash("sha256").update(t).digest("base64")===n)return void console.log(`${I} Local is latested`)}catch(e){}let o;console.log(`${I} Start to update local`);try{o=yield E(t)}catch(e){return void console.error(`${I} Download error ${e.message}`)}if(O.default.createHash("sha256").update(o).digest("base64")!==n)throw new Error("Failed to verify");yield B.default.writeFile(e,o),console.log(`${I} Updated`)}))}};var x={};Object.defineProperty(x,"__esModule",{value:!0}),x.composeAssetsByCompileMode=void 0;const F=y,D=P;function k(...e){return e.join("\n")}function $(e,t){return t.target===F.ECompileTargetType.Cube?{}:{workerTop:e.bugmeWPreview,webTop:`window.__BUGME_ENV__='preview';${e.bugmeRPreview}`,htmlTop:`<script>window.__BUGME_ENV__='preview';${e.bugmeRPreview}<\/script>`}}function U(e){return`<script snapshot-delete="">${null!=e?e:""}<\/script>`}function N(e,t){return{webTop:e.bugmeRRemote,htmlTop:U(e.bugmeRRemote)}}function L(e,t){return t.compilePlugin?{workerTop:e.bugmeWRemote,pluginWorkerTop:e.tyroAgent,webTop:e.bugmeRRemote,htmlTop:U(e.bugmeRRemote)}:{workerTop:k(e.tyroAgent||"",e.bugmeWRemote||""),webTop:e.bugmeRRemote,htmlTop:U(e.bugmeRRemote)}}function q(e,t){return{workerTop:k("var __BUGME_CONSOLE_ENABLE__=true;",e.bugmeWRemote||""),webTop:e.bugmeRRemote,htmlTop:U(e.bugmeRRemote)}}function J(e,t){if(t.target===F.ECompileTargetType.Cube)return{};{const n={webTop:e.bugmeRRemote,htmlTop:U(e.bugmeRRemote)};return t.compilePlugin&&(n.workerTop=e.bugmeWRemote),n}}x.composeAssetsByCompileMode=function(e,t){let n;switch(t.mode){case F.ECompileModeType.Preview:n=$;break;case F.ECompileModeType.Remote:n=N;break;case F.ECompileModeType.Remotex:n=L;break;case F.ECompileModeType.RemotexLite:n=q;break;case F.ECompileModeType.RemoteBoatman:n=J;break;default:throw new Error(`[${D.libName}] unknown compile mode: ${t.mode}`)}return n(e,t)};var W={};Object.defineProperty(W,"__esModule",{value:!0}),W.BuilderDebugContext=void 0;const Q=l.default;W.BuilderDebugContext=class{constructor(e){this.assetsQueryUrl="",this.injectCodeTempPath="",this.offlineDirectoryPath="",this.readonlyDirectoryPath="",this.assetsMapFilename="",this.assetsQueryUrl=e.assetsQueryUrl,this.injectCodeTempPath=e.injectCodeTempPath,this.offlineDirectoryPath=e.offlineDirectoryPath,this.readonlyDirectoryPath=e.readonlyDirectoryPath,this.assetsMapFilename=e.assetsMapFilename,this.boatmanFilename=e.boatmanFilename}getAssetsMapFilePath(){return(0,Q.join)(this.offlineDirectoryPath,this.assetsMapFilename)}getBoatmanFilePath(e){return(0,Q.join)(this.offlineDirectoryPath,this.boatmanFilename[e])}getReadonlyAssetsMapFilePath(){return(0,Q.join)(this.readonlyDirectoryPath,this.assetsMapFilename)}getReadonlyBoatmanFilePath(e){return(0,Q.join)(this.readonlyDirectoryPath,this.boatmanFilename[e])}};var G=c&&c.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(a,r){function i(e){try{u(o.next(e))}catch(e){r(e)}}function s(e){try{u(o.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}u((o=o.apply(e,t||[])).next())}))},H=c&&c.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(b,"__esModule",{value:!0}),b.BuilderDebugClient=void 0;const K=H(i.default),V=y,z=C,X=P,Y=x,Z=W;function ee(e){const t={target:V.ECompileTargetType.Mini};return e.target&&Object.keys(V.ECompileTargetType).indexOf(e.target)>-1&&(t.target=e.target),t}function te(e){const t=Object.assign({},e);if(!t.mode||-1===Object.keys(V.ECompileModeType).indexOf(t.mode))throw new Error(`[${X.libName}] invalid 'mode' option: ${t.mode}`);return t.target&&-1!==Object.keys(V.ECompileTargetType).indexOf(t.target)||(t.target=V.ECompileTargetType.Mini),e}b.BuilderDebugClient=class{constructor(e){this.context=new Z.BuilderDebugContext(Object.assign(Object.assign({},X.defaultConfig),e))}updateOfflineAssets(e){return G(this,void 0,void 0,(function*(){this.assetsUpdater||(this.assetsUpdater=new z.AssetsUpdater(this.context)),e.cacheToday?yield this.assetsUpdater.updateOfflineAssetsToday():yield this.assetsUpdater.updateOfflineAssets()}))}generateInjectCode(e){return G(this,void 0,void 0,(function*(){e=te(e);const t=yield this.readAssetsMap();return(0,Y.composeAssetsByCompileMode)(t,e)}))}generateInjectCodeSync(e){e=te(e);const t=this.readAssetsMapSync();return(0,Y.composeAssetsByCompileMode)(t,e)}readAssetsMapSync(){let e=K.default.readJSONSync(this.context.getAssetsMapFilePath(),{throws:!1});return e||(console.log(`[${X.libName}] offline assets_map file was damaged, fallback to readonly file`),e=K.default.readJSONSync(this.context.getReadonlyAssetsMapFilePath())),e}readAssetsMap(){return G(this,void 0,void 0,(function*(){let e;try{e=yield K.default.readJSON(this.context.getAssetsMapFilePath(),{throws:!1})}catch(e){}return e||(console.log(`[${X.libName}] offline assets_map file was damaged, fallback to readonly file`),e=yield K.default.readJSON(this.context.getReadonlyAssetsMapFilePath())),e}))}generateInjectCodePath(e){return G(this,void 0,void 0,(function*(){const t=yield this.generateInjectCode(e);return yield K.default.writeJSON(X.defaultConfig.injectCodeTempPath,t),X.defaultConfig.injectCodeTempPath}))}generateInjectCodePathSync(e){const t=this.generateInjectCodeSync(e);return K.default.writeJSONSync(X.defaultConfig.injectCodeTempPath,t),X.defaultConfig.injectCodeTempPath}getBoatmanBundlePath(e){return G(this,void 0,void 0,(function*(){const t=ee(e);try{const e=this.context.getBoatmanFilePath(t.target);return yield K.default.access(e,K.default.constants.R_OK),e}catch(e){return this.context.getReadonlyBoatmanFilePath(t.target)}}))}getBoatmanBundlePathSync(e){const t=ee(e);try{const e=this.context.getBoatmanFilePath(t.target);return K.default.accessSync(e,K.default.constants.R_OK),e}catch(e){return this.context.getReadonlyBoatmanFilePath(t.target)}}};var ne={},oe=c&&c.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(a,r){function i(e){try{u(o.next(e))}catch(e){r(e)}}function s(e){try{u(o.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}u((o=o.apply(e,t||[])).next())}))};Object.defineProperty(ne,"__esModule",{value:!0}),ne.readAssetsMap=ne.readAssetsMapSync=ne.loadConfig=ne.getBoatmanBundlePathSync=ne.getBoatmanBundlePath=ne.generateInjectCodePathSync=ne.generateInjectCodePath=ne.generateInjectCodeSync=ne.generateInjectCode=ne.updateInjectCodeAssets=void 0;const ae=b;let re;function ie(){return re||(re=new ae.BuilderDebugClient),re}ne.updateInjectCodeAssets=function(e={}){return oe(this,void 0,void 0,(function*(){return ie().updateOfflineAssets(e)}))},ne.generateInjectCode=function(e){return oe(this,void 0,void 0,(function*(){return ie().generateInjectCode(e)}))},ne.generateInjectCodeSync=function(e){return ie().generateInjectCodeSync(e)},ne.generateInjectCodePath=function(e){return oe(this,void 0,void 0,(function*(){return ie().generateInjectCodePath(e)}))},ne.generateInjectCodePathSync=function(e){return ie().generateInjectCodePathSync(e)},ne.getBoatmanBundlePath=function(e={}){return oe(this,void 0,void 0,(function*(){return ie().getBoatmanBundlePath(e)}))},ne.getBoatmanBundlePathSync=function(e={}){return ie().getBoatmanBundlePathSync(e)},ne.loadConfig=function(e){re=new ae.BuilderDebugClient(e)},ne.readAssetsMapSync=function(){return ie().readAssetsMapSync()},ne.readAssetsMap=function(){return ie().readAssetsMap()},function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.loadConfig=e.getBoatmanBundlePathSync=e.readAssetsMap=e.readAssetsMapSync=e.getBoatmanBundlePath=e.generateInjectCodePathSync=e.generateInjectCodePath=e.generateInjectCodeSync=e.generateInjectCode=e.updateInjectCodeAssets=e.BuilderDebugClient=e.ECompileTargetType=e.ECompileModeType=void 0;var t=y;Object.defineProperty(e,"ECompileModeType",{enumerable:!0,get:function(){return t.ECompileModeType}}),Object.defineProperty(e,"ECompileTargetType",{enumerable:!0,get:function(){return t.ECompileTargetType}});var n=b;Object.defineProperty(e,"BuilderDebugClient",{enumerable:!0,get:function(){return n.BuilderDebugClient}});var o=ne;Object.defineProperty(e,"updateInjectCodeAssets",{enumerable:!0,get:function(){return o.updateInjectCodeAssets}}),Object.defineProperty(e,"generateInjectCode",{enumerable:!0,get:function(){return o.generateInjectCode}}),Object.defineProperty(e,"generateInjectCodeSync",{enumerable:!0,get:function(){return o.generateInjectCodeSync}}),Object.defineProperty(e,"generateInjectCodePath",{enumerable:!0,get:function(){return o.generateInjectCodePath}}),Object.defineProperty(e,"generateInjectCodePathSync",{enumerable:!0,get:function(){return o.generateInjectCodePathSync}}),Object.defineProperty(e,"getBoatmanBundlePath",{enumerable:!0,get:function(){return o.getBoatmanBundlePath}}),Object.defineProperty(e,"readAssetsMapSync",{enumerable:!0,get:function(){return o.readAssetsMapSync}}),Object.defineProperty(e,"readAssetsMap",{enumerable:!0,get:function(){return o.readAssetsMap}}),Object.defineProperty(e,"getBoatmanBundlePathSync",{enumerable:!0,get:function(){return o.getBoatmanBundlePathSync}}),Object.defineProperty(e,"loadConfig",{enumerable:!0,get:function(){return o.loadConfig}})}(h);var se=p(h);module.exports=se;
